name: Nightly Health Proofs Collection

on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily
  workflow_dispatch:
    inputs:
      include_cost_analysis:
        description: "Include detailed cost analysis"
        type: boolean
        default: true
      emergency_health_check:
        description: "Emergency health check mode"
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

env:
  # Service URLs for health checks
  DASHBOARD_URL: https://sophiaai-dashboard-v2.fly.dev
  MCP_REPO_URL: https://sophiaai-mcp-repo-v2.fly.dev
  MCP_RESEARCH_URL: https://sophiaai-mcp-research-v2.fly.dev
  MCP_CONTEXT_URL: https://sophiaai-mcp-context-v2.fly.dev
  MCP_BUSINESS_URL: https://sophiaai-mcp-business-v2.fly.dev
  JOBS_URL: https://sophiaai-jobs-v2.fly.dev
  FLY_ORG: pay-ready
  ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}

jobs:
  comprehensive-health-proofs:
    name: Comprehensive Health & Cost Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Install jq and curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Fly authentication check
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "⚠️ FLY_API_TOKEN not available - some checks will be skipped"
            echo "FLY_AUTH_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "✅ Fly authentication available"
            echo "FLY_AUTH_AVAILABLE=true" >> $GITHUB_ENV
          fi

      - name: Comprehensive service health checks
        run: |
          echo "🏥 Running comprehensive nightly health checks..."
          mkdir -p proofs/nightly/health/$(date +%Y-%m-%d)
          
          HEALTH_DATE=$(date +%Y-%m-%d)
          HEALTH_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          declare -A services=(
            ["dashboard"]="${DASHBOARD_URL}"
            ["mcp-repo"]="${MCP_REPO_URL}"
            ["mcp-research"]="${MCP_RESEARCH_URL}"
            ["mcp-context"]="${MCP_CONTEXT_URL}"
            ["mcp-business"]="${MCP_BUSINESS_URL}"
            ["jobs"]="${JOBS_URL}"
          )
          
          health_summary="{\"timestamp\":\"$HEALTH_TIMESTAMP\",\"date\":\"$HEALTH_DATE\",\"services\":{"
          first=true
          all_healthy=true
          
          for service in "${!services[@]}"; do
            base_url="${services[$service]}"
            
            if [ "$first" = false ]; then
              health_summary="$health_summary,"
            fi
            
            echo "🔍 Checking $service at $base_url"
            
            # Health check with detailed metrics
            health_status="unknown"
            response_time="0"
            http_code="0"
            
            start_time=$(date +%s%3N)
            if response=$(curl -s -w "%{http_code}" -o /tmp/health_response "$base_url/healthz" 2>/dev/null); then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              http_code="$response"
              
              if [ "$http_code" = "200" ]; then
                health_status="healthy"
                echo "✅ $service: healthy (${response_time}ms)"
              else
                health_status="unhealthy"
                all_healthy=false
                echo "❌ $service: HTTP $http_code (${response_time}ms)"
              fi
            else
              health_status="unreachable"
              all_healthy=false
              echo "💥 $service: unreachable"
            fi
            
            # Build info check
            build_info=""
            if curl -s "$base_url/__build" > /tmp/build_info 2>/dev/null; then
              build_info=$(cat /tmp/build_info | jq -c . 2>/dev/null || echo "\"unavailable\"")
            else
              build_info="\"unavailable\""
            fi
            
            # Detailed service proof
            cat > "proofs/nightly/health/$HEALTH_DATE/${service}_health.json" <<EOF
          {
            "service": "$service",
            "timestamp": "$HEALTH_TIMESTAMP",
            "url": "$base_url",
            "status": "$health_status",
            "http_code": $http_code,
            "response_time_ms": $response_time,
            "build_info": $build_info,
            "healthz_response": $(cat /tmp/health_response 2>/dev/null | jq -Rs . || echo "\"unavailable\"")
          }
          EOF
            
            health_summary="$health_summary\"$service\":{\"status\":\"$health_status\",\"http_code\":$http_code,\"response_time_ms\":$response_time}"
            first=false
          done
          
          health_summary="$health_summary},\"all_healthy\":$all_healthy}"
          
          # Save comprehensive summary
          echo "$health_summary" | jq . > "proofs/nightly/health/$HEALTH_DATE/summary.json"
          
          echo "HEALTH_ALL_SERVICES_UP=$all_healthy" >> $GITHUB_ENV
          echo "HEALTH_SUMMARY_PATH=proofs/nightly/health/$HEALTH_DATE/summary.json" >> $GITHUB_ENV

      - name: Fly.io cost and resource monitoring
        if: ${{ env.FLY_AUTH_AVAILABLE == 'true' && (inputs.include_cost_analysis != false) }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "💰 Collecting Fly.io cost and resource data..."
          mkdir -p proofs/cost/$(date +%Y-%m-%d)
          
          COST_DATE=$(date +%Y-%m-%d)
          COST_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Get all apps
          echo "📊 Scanning Fly apps..."
          apps_list=$(flyctl apps list --json 2>/dev/null || echo "[]")
          echo "$apps_list" | jq . > "proofs/cost/$COST_DATE/apps_list.json"
          
          # Get machines for each app
          total_machines=0
          total_memory_mb=0
          total_cpu_cores=0
          app_details="[]"
          
          for app in $(echo "$apps_list" | jq -r '.[].Name' 2>/dev/null); do
            echo "🔍 Analyzing app: $app"
            
            machines=$(flyctl machines list -a "$app" --json 2>/dev/null || echo "[]")
            machine_count=$(echo "$machines" | jq 'length')
            
            if [ "$machine_count" -gt 0 ]; then
              app_memory=$(echo "$machines" | jq '[.[] | .config.guest.memory_mb // 0] | add')
              app_cpu=$(echo "$machines" | jq '[.[] | .config.guest.cpus // 0] | add')
              
              total_machines=$((total_machines + machine_count))
              total_memory_mb=$((total_memory_mb + app_memory))
              total_cpu_cores=$((total_cpu_cores + app_cpu))
              
              app_details=$(echo "$app_details" | jq --arg app "$app" --argjson machines "$machines" --argjson count "$machine_count" --argjson memory "$app_memory" --argjson cpu "$app_cpu" '. + [{
                "app": $app,
                "machine_count": $count,
                "total_memory_mb": $memory,
                "total_cpu_cores": $cpu,
                "machines": $machines
              }]')
            fi
          done
          
          # Create cost summary
          cost_summary=$(cat <<EOF
          {
            "timestamp": "$COST_TIMESTAMP",
            "date": "$COST_DATE",
            "organization": "$FLY_ORG",
            "totals": {
              "apps": $(echo "$apps_list" | jq 'length'),
              "machines": $total_machines,
              "total_memory_mb": $total_memory_mb,
              "total_cpu_cores": $total_cpu_cores
            },
            "apps": $app_details
          }
          EOF
          )
          
          echo "$cost_summary" | jq . > "proofs/cost/$COST_DATE/usage_$COST_DATE.json"
          
          echo "📊 Resource summary:"
          echo "  Apps: $(echo "$apps_list" | jq 'length')"
          echo "  Machines: $total_machines"
          echo "  Memory: ${total_memory_mb}MB"
          echo "  CPU: ${total_cpu_cores} cores"
          
          echo "RESOURCE_MACHINE_COUNT=$total_machines" >> $GITHUB_ENV
          echo "RESOURCE_MEMORY_MB=$total_memory_mb" >> $GITHUB_ENV

      - name: Historical trend analysis
        run: |
          echo "📈 Analyzing historical trends..."
          mkdir -p proofs/trends
          
          # Analyze health trends over last 7 days
          TREND_DATA="[]"
          for i in {0..6}; do
            check_date=$(date -d "-${i} days" +%Y-%m-%d)
            summary_file="proofs/nightly/health/$check_date/summary.json"
            
            if [ -f "$summary_file" ]; then
              day_data=$(jq --arg date "$check_date" '{date: $date, all_healthy: .all_healthy, service_count: (.services | length)}' "$summary_file" 2>/dev/null || echo "{\"date\":\"$check_date\",\"all_healthy\":false,\"service_count\":0}")
              TREND_DATA=$(echo "$TREND_DATA" | jq ". + [$day_data]")
            fi
          done
          
          # Calculate reliability metrics
          if [ "$(echo "$TREND_DATA" | jq 'length')" -gt 0 ]; then
            healthy_days=$(echo "$TREND_DATA" | jq '[.[] | select(.all_healthy == true)] | length')
            total_days=$(echo "$TREND_DATA" | jq 'length')
            reliability_pct=$(echo "scale=2; $healthy_days * 100 / $total_days" | bc 2>/dev/null || echo "0")
            
            trend_summary=$(cat <<EOF
          {
            "generated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "period": "7_days",
            "metrics": {
              "total_days_analyzed": $total_days,
              "healthy_days": $healthy_days,
              "reliability_percentage": $reliability_pct
            },
            "daily_data": $TREND_DATA
          }
          EOF
            )
            
            echo "$trend_summary" | jq . > proofs/trends/7_day_health_trend.json
            echo "📊 7-day reliability: ${reliability_pct}%"
            
            echo "RELIABILITY_PERCENTAGE=$reliability_pct" >> $GITHUB_ENV
          fi

      - name: Generate alerts for degraded services
        if: ${{ env.HEALTH_ALL_SERVICES_UP == 'false' || inputs.emergency_health_check == true }}
        env:
          WEBHOOK_URL: ${{ env.ALERT_WEBHOOK_URL }}
        run: |
          echo "🚨 Service degradation detected - generating alerts..."
          
          if [ -n "$WEBHOOK_URL" ]; then
            alert_payload=$(cat <<EOF
          {
            "text": "🚨 Sophia AI Health Alert",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Sophia AI Health Alert*\n\n⚠️ Service degradation detected during nightly health check\n\n*Timestamp:* $(date -u)\n*Reliability:* ${RELIABILITY_PERCENTAGE:-"N/A"}%\n*Total Machines:* ${RESOURCE_MACHINE_COUNT:-"N/A"}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Action Required:*\n• Review health proofs in \`proofs/nightly/health/\`\n• Check service logs\n• Consider emergency deployment if needed"
                }
              }
            ]
          }
          EOF
          )
            
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$alert_payload" \
              "$WEBHOOK_URL" || echo "⚠️ Failed to send alert webhook"
          else
            echo "⚠️ ALERT_WEBHOOK_URL not configured - alerts not sent"
          fi

      - name: Commit nightly proofs
        run: |
          git config user.name "sophia-bot"
          git config user.email "sophia-bot@users.noreply.github.com"
          
          # Add all generated proofs
          git add proofs/nightly/ proofs/cost/ proofs/trends/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            commit_msg="[nightly-proofs] Health & cost monitoring $(date +%Y-%m-%d)"
            if [ "${{ env.HEALTH_ALL_SERVICES_UP }}" = "false" ]; then
              commit_msg="$commit_msg - ⚠️ SERVICE DEGRADATION"
            fi
            
            git commit -m "$commit_msg"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
            
            echo "✅ Nightly proofs committed successfully"
          else
            echo "ℹ️ No new proof changes to commit"
          fi

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-health-proofs-${{ github.run_id }}
          path: |
            proofs/nightly/
            proofs/cost/
            proofs/trends/
          retention-days: 30

      - name: Generate nightly summary report
        run: |
          echo "# 🌙 Nightly Health & Cost Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**All Services Healthy:** ${{ env.HEALTH_ALL_SERVICES_UP }}" >> $GITHUB_STEP_SUMMARY
          echo "**7-Day Reliability:** ${RELIABILITY_PERCENTAGE:-"N/A"}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📊 Resource Usage" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Machines:** ${RESOURCE_MACHINE_COUNT:-"N/A"}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Memory:** ${RESOURCE_MEMORY_MB:-"N/A"}MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📁 Proof Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Health proofs: \`proofs/nightly/health/$(date +%Y-%m-%d)/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Cost analysis: \`proofs/cost/$(date +%Y-%m-%d)/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Trend analysis: \`proofs/trends/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.HEALTH_ALL_SERVICES_UP }}" = "false" ]; then
            echo "## ⚠️ Action Items" >> $GITHUB_STEP_SUMMARY
            echo "- Review failed services in health proofs" >> $GITHUB_STEP_SUMMARY
            echo "- Check application logs" >> $GITHUB_STEP_SUMMARY
            echo "- Consider triggering emergency deployment" >> $GITHUB_STEP_SUMMARY
          fi