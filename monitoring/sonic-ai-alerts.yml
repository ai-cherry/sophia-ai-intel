# Sonic AI Specific Alerting Rules
# This file contains alerting rules specific to Sonic AI service

groups:
  - name: sonic-ai-alerts
    rules:
      # Service availability alerts
      - alert: SonicAIInstanceDown
        expr: up{service_name="sonic-ai"} == 0
        for: 2m
        labels:
          severity: critical
          service: sonic-ai
        annotations:
          summary: "Sonic AI instance is down"
          description: "Sonic AI instance {{ $labels.instance }} has been down for more than 2 minutes"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-down"

      - alert: SonicAIModelNotLoaded
        expr: sonic_ai_model_loaded == 0
        for: 1m
        labels:
          severity: critical
          service: sonic-ai
        annotations:
          summary: "Sonic AI model not loaded"
          description: "Sonic AI reasoning model is not loaded on {{ $labels.instance }}"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-model"

      # Performance alerts
      - alert: SonicAIHighResponseTime
        expr: sonic_ai_avg_response_time_ms > 2000
        for: 5m
        labels:
          severity: warning
          service: sonic-ai
        annotations:
          summary: "Sonic AI high response time"
          description: "Sonic AI average response time is {{ $value }}ms, above 2 second threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-performance"

      - alert: SonicAIHighErrorRate
        expr: rate(sonic_ai_errors_total[5m]) / rate(sonic_ai_total_requests_processed[5m]) * 100 > 5
        for: 3m
        labels:
          severity: warning
          service: sonic-ai
        annotations:
          summary: "Sonic AI high error rate"
          description: "Sonic AI error rate is {{ $value }}%, above 5% threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-errors"

      # Resource alerts
      - alert: SonicAIHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{service_name="sonic-ai"}[5m]) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: sonic-ai
        annotations:
          summary: "Sonic AI high CPU usage"
          description: "Sonic AI CPU usage is {{ $value }}%, above 85% threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-resources"

      - alert: SonicAIHighMemoryUsage
        expr: container_memory_usage_bytes{service_name="sonic-ai"} / container_memory_max_usage_bytes{service_name="sonic-ai"} * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: sonic-ai
        annotations:
          summary: "Sonic AI high memory usage"
          description: "Sonic AI memory usage is {{ $value }}%, above 90% threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-resources"

      # AI-specific alerts
      - alert: SonicAILowConfidence
        expr: sonic_ai_reasoning_confidence_avg < 0.8
        for: 5m
        labels:
          severity: info
          service: sonic-ai
        annotations:
          summary: "Sonic AI low confidence scores"
          description: "Sonic AI reasoning confidence is {{ $value }}, below 0.8 threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-confidence"

      - alert: SonicAIHighActiveRequests
        expr: sonic_ai_active_requests > 10
        for: 3m
        labels:
          severity: info
          service: sonic-ai
        annotations:
          summary: "Sonic AI high concurrent requests"
          description: "Sonic AI has {{ $value }} active concurrent requests, above normal threshold"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-concurrency"

      # MCP Integration alerts
      - alert: SonicAIMCPIntegrationFailure
        expr: sonic_ai_mcp_integration_health < 1
        for: 2m
        labels:
          severity: warning
          service: sonic-ai
        annotations:
          summary: "Sonic AI MCP integration failure"
          description: "Sonic AI MCP integration with {{ $labels.mcp_service }} is failing"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-mcp"

  - name: sonic-ai-scaling-alerts
    rules:
      - alert: SonicAINeedsScaling
        expr: sonic_ai_active_requests > 8 and rate(sonic_ai_total_requests_processed[2m]) > 10
        for: 3m
        labels:
          severity: info
          service: sonic-ai
          scaling: "recommended"
        annotations:
          summary: "Sonic AI scaling recommended"
          description: "Sonic AI is processing high load, consider scaling up replicas"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-scaling"

      - alert: SonicAIOverProvisioned
        expr: sonic_ai_active_requests < 2 and rate(sonic_ai_total_requests_processed[10m]) < 5
        for: 15m
        labels:
          severity: info
          service: sonic-ai
          scaling: "consider_down"
        annotations:
          summary: "Sonic AI potentially over-provisioned"
          description: "Sonic AI has low utilization, consider scaling down"
          runbook_url: "https://github.com/ai-cherry/sophia-ai-intel-1/blob/main/docs/troubleshooting.md#sonic-ai-scaling"